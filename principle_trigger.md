# Camera and laser trigger

In order to not overexpose sensitive samples to light, lasers in microscope are often synchronised with the camera. That way, laser light is only emitted when the camera is accumulating photons and not in between frames. The simplest way to achieve this synchronisation is to directly connect a signal generated by the camera to the lasers trigger input. We will refer here to this signal as the **exposure signal**. Most camera used in microscopy, whether EMCCD or sCMOS, come with such an output signal.

Directly connecting the camera to the laser does not allow any flexibility, and the laser only reproduces the frames acquisition. MicroFPGA can process the `exposure signal` from a camera in order to generate complex triggering patterns, including fast pulsing or a trigger pattern. We describe the `laser trigger signal` in the corresponding section: [Laser triggering](#laser-triggering).

In certain cases, for instance when having multiple cameras, some cameras can themselves be triggered. Usually, the trigger signal they received is a short pulse corresponding to the beginning of a frame: the `fire signal`. The `fire signal` can be generated by the main camera or by another device. 

MicroFPGA has two camera modes: **PASSIVE** and **ACTIVE**. In PASSIVE mode, the FPGA receives an `exposure signal` from a camera and processes it to trigger the lasers. In ACTIVE mode, the FPGA generates both `fire signal` and `laser trigger signal`. In this case, the `fire signal` can be used to trigger a camera, and the `laser trigger signal` is based on an `exposure signal` that is internal to the FPGA and in sync with the `fire signal`. We dive more in depth in the [Camera triggering](#camera-triggering) section.

Note that the laser triggering parameters are the same in both camera modes (PASSIVE or ACTIVE), and we will therefore describe them first.


## Laser triggering 

The laser trigger outputs are based on an `exposure signal` that is HIGH (>2V) when the camera is exposing and LOW (<2V) when the camera pixels are being registered. If the FPGA is in PASSIVE camera mode, the `expoure signal` must be provided to the FPGA (refer to the [pins mapping](pins_br.md) to identify where to input the signal). In ACTIVE camera mode, the `exposure signal` is generated internally by the FPGA. Note that there is only one `exposure signal`, but multiple `laser trigger signals` generated by the FPGA.

MicroFPGA offers several laser trigger mode: OFF, ON, RISING, FALLING and FOLLOW. Each mode processes the `exposure signal` differently. Additional parameters might influence the resulting `laser trigger signal` in some modes. The modes and their parameters are summarized in this table;

| Trigger mode |         Parameters         |                         Description                          |
| :----------: | :------------------------: | :----------------------------------------------------------: |
|     OFF      |                            |                   The laser is always off                    |
|      ON      |                            |                    The laser is always on                    |
|    RISING    | **duration<br />sequence** | The laser is pulsed for **duration** &#956;s, on each **rising** edge |
|   FALLING    | **duration<br />sequence** | The laser is pulsed for **duration** &#956;s, on each **falling** edge |
|    FOLLOW    |        **sequence**        |            The laser follows the exposure signal             |



| Parameter |  Range  |                         Description                          |
| :-------: | :-----: | :----------------------------------------------------------: |
|   mode    |   0-4   |                 Sets the laser trigger mode                  |
| duration  | 0-65535 | Duration of the pulse in &#956;s in RISING and FALLING modes |
| sequence  | 0-65535 |                                                              |

You need to only provide a single camera input. In addition to **mode** and **duration**, a third parameter can be set: **sequence**. The **sequence** corresponds to a 16 bits number (0 to 65535) which encodes a trigger sequence in its bits sequence. MicroFPGA reads the binary number from the most-significant bit to the least significant one. If the bit is 1, then the laser will be triggered during the next camera exposure. If it is 0, it will not. The sequence is applied in **RISING**, **FALLING** and **CAMERA** modes. The lasers are synchronized, allowing alternating triggering.  



**LASER TRIGGER FIGURE HERE**





**Trigger sequence examples**:


|                 Decimal                  |                 Binary                 |                     Description                     |
| :--------------------------------------: | :------------------------------------: | :-------------------------------------------------: |
|                    0                     |            0000000000000000            |               The laser is always off               |
|                  65535                   |            1111111111111111            |           The laser is on at every frame            |
|                  43690                   |            1010101010101010            | The laser is on every two frames (starting with on) |
|                  51884                   |            1100101010101100            |          on-on-off-off-on-off-on...etc...           |
| **Laser1**: 43690 <br> **Laser2**: 21845 | 1010101010101010 <br> 0101010101010101 |      **Laser1** and **Laser2** are alternating      |

Use a [binary-to-decimal converter](https://www.binaryhexconverter.com/binary-to-decimal-converter "One binary to decimal converter") to get the sequence right.

**Summary**, for each laser (laser number = #):

| Property  |                         Description                          |                             Use                              |
| :-------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|   Mode#   | Triggering mode of the laser <br>(OFF\ON\RISING\FALLING\CAMERA modes) | OFF = 0 <br> ON = 1 <br> RISING = 2 <br> FALLING = 3 <br> CAMERA = 4 |
| Duration# | Pulse length of the trigger in us <br>(RISING\FALLING modes) |                          0-65535 us                          |
| Sequence# | Decimal value corresponding to a 16 bits <br>binary sequence of ON and OFF <br>(RISING\FALLING\CAMERA modes) |                           0-65535                            |




However, direct triggering is not flexible. MicroFPGA act as a camera signal modulator to produce a laser trigger that can be pulsed or synchronized between lasers, including complex patterns. The camera signal must be provided to the FPGA (refer to the [pins mapping](pins_br.md)).

:warning: **Do not supply the camera signal with more than 3.3V to the FPGA** :warning:

EMCCD often have a 5 V trigger. Therefore, the camera trigger needs to be scaled down to 3.3 V prior to the FPGA. sCMOS cameras trigger usually runs on 3.3 V.